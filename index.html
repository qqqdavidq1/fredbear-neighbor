<!DOCTYPE html>
<html>
<head>
    <title>Hello Neighbor: FREDBEAR FINAL</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Courier New', monospace; user-select: none; }
        
        #hud {
            position: absolute; top: 15px; left: 15px;
            color: #00ff00; background: rgba(0,0,0,0.8); padding: 15px; 
            border: 2px solid #00ff00; border-radius: 8px;
            font-size: 16px; min-width: 300px; z-index: 10;
        }

        #jumpscare-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: black; display: none; z-index: 999;
            align-items: center; justify-content: center;
        }
        video { width: 100%; height: 100%; object-fit: cover; }

        #crosshair {
            position: absolute; top: 50%; left: 50%; width: 6px; height: 6px;
            background: white; border: 2px solid black; border-radius: 50%; 
            transform: translate(-50%, -50%); pointer-events: none; z-index: 5;
        }

        #debug-msg {
            color: yellow; font-weight: bold; margin-top: 10px; border-top: 1px solid #555; padding-top: 5px;
            font-size: 14px;
        }
        
        .highlight { color: cyan; }
    </style>
</head>
<body>
    <div id="crosshair"></div>
    
    <div id="jumpscare-container">
        <video id="scare-vid" src="jumpscare.mp4"></video>
    </div>

    <div id="hud">
        STATUS: <span id="status">NEIGHBOR ACTIVE</span><br>
        <div id="inv">Shotgun: [EQUIPPED]</div>
        <div id="debug-msg">
            ANIMATION STATE:<br>
            Current: <span id="anim-name" class="highlight">Loading...</span><br>
            <br>
            [O] Shrink / [P] Grow<br>
            Size: <span id="size-display">10.0</span>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'https://unpkg.com/three@0.126.0/build/three.module.js';
        import { GLTFLoader } from 'https://unpkg.com/three@0.126.0/examples/jsm/loaders/GLTFLoader.js';

        // --- SETUP ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB);
        scene.fog = new THREE.Fog(0x87CEEB, 10, 400);

        const camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 2000);
        camera.position.set(0, 10, 160); 
        camera.rotation.y = Math.PI;

        const renderer = new THREE.WebGLRenderer({antialias:true});
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.outputEncoding = THREE.sRGBEncoding;
        document.body.appendChild(renderer.domElement);

        const light = new THREE.HemisphereLight(0xffffff, 0x444444, 1.0);
        scene.add(light);
        const sun = new THREE.DirectionalLight(0xffffff, 1.5);
        sun.position.set(50, 200, 100);
        sun.castShadow = true;
        scene.add(sun);

        // --- ASSETS ---
        const audioRun = new Audio('run.mp3');
        audioRun.loop = true;
        const scareVid = document.getElementById('scare-vid');
        scareVid.onended = function() { location.reload(); };

        // --- MAP ---
        const wallMat = new THREE.MeshStandardMaterial({ color: 0xFF8C00 }); 
        const floorMat = new THREE.MeshStandardMaterial({ color: 0x5d4037 });
        
        const ground = new THREE.Mesh(new THREE.PlaneGeometry(3000,3000), new THREE.MeshStandardMaterial({color: 0x2e7d32}));
        ground.rotation.x = -Math.PI/2; scene.add(ground);
        const road = new THREE.Mesh(new THREE.PlaneGeometry(3000,150), new THREE.MeshStandardMaterial({color: 0x333333}));
        road.rotation.x = -Math.PI/2; road.position.set(0,0.1,150); scene.add(road);

        // House
        const f1 = new THREE.Mesh(new THREE.BoxGeometry(60,1,60), floorMat); f1.position.set(0,0.2,0); scene.add(f1);
        const w1 = new THREE.Mesh(new THREE.BoxGeometry(20,30,2), wallMat); w1.position.set(-20,15,30); scene.add(w1);
        const w2 = new THREE.Mesh(new THREE.BoxGeometry(20,30,2), wallMat); w2.position.set(20,15,30); scene.add(w2);
        const wBack = new THREE.Mesh(new THREE.BoxGeometry(60,30,2), wallMat); wBack.position.set(0,15,-30); scene.add(wBack);
        
        // Shed
        const sMat = new THREE.MeshStandardMaterial({color: 0x8d6e63});
        const sL=new THREE.Mesh(new THREE.BoxGeometry(2,20,20),sMat); sL.position.set(70,10,-80); scene.add(sL);
        const sR=new THREE.Mesh(new THREE.BoxGeometry(2,20,20),sMat); sR.position.set(90,10,-80); scene.add(sR);
        const sB=new THREE.Mesh(new THREE.BoxGeometry(20,20,2),sMat); sB.position.set(80,10,-90); scene.add(sB);

        // --- NEIGHBOR ---
        const neighbor = new THREE.Group();
        const nMesh = new THREE.Mesh(new THREE.BoxGeometry(4,12,4), new THREE.MeshStandardMaterial({color:0xff0000}));
        nMesh.position.y=6; neighbor.add(nMesh);
        scene.add(neighbor); neighbor.position.set(-20,0,-20);

        // --- FREDBEAR SYSTEM ---
        let fredbearModel = null;
        let mixer = null;
        let scaleVal = 10.0;
        let animationsList = [];
        let currentAction = null;
        
        // ANIMATION INDICES FROM YOUR SCREENSHOTS
        const ANIM_IDLE = 21; // Test2
        const ANIM_RUN = 16;  // Fredbear_Run_Anim
        const ANIM_STUN = 1;  // Fredbear_Beartrap_Anim
        
        const loader = new GLTFLoader();
        loader.load('scene.gltf', function(gltf) {
            console.log("FREDBEAR LOADED!");
            fredbearModel = gltf.scene;
            fredbearModel.position.set(20, 0, -50); 
            fredbearModel.scale.set(scaleVal, scaleVal, scaleVal);
            scene.add(fredbearModel);

            // ANIMATION SETUP
            if(gltf.animations.length > 0) {
                animationsList = gltf.animations;
                mixer = new THREE.AnimationMixer(fredbearModel);
                
                // START IDLE (Neighbor Alive)
                playAnimation(ANIM_IDLE); 
            } else {
                document.getElementById('anim-name').innerText = "NO ANIMATIONS";
            }
        }, undefined, function(e) { console.error(e); });

        // Helper to switch animations smoothly
        function playAnimation(index) {
            if(!mixer || !animationsList[index]) return;
            
            const newClip = animationsList[index];
            const newAction = mixer.clipAction(newClip);
            
            if(currentAction && currentAction !== newAction) {
                currentAction.fadeOut(0.2);
            }
            
            newAction.reset();
            newAction.fadeIn(0.2);
            newAction.play();
            currentAction = newAction;

            document.getElementById('anim-name').innerText = `[${index}] ${newClip.name}`;
        }

        // --- SHOTGUN ---
        const gun = new THREE.Mesh(new THREE.BoxGeometry(1, 1, 6), new THREE.MeshStandardMaterial({color: 0x555555}));
        gun.position.set(2, -2, -4);
        camera.add(gun);

        // --- LOGIC ---
        let neighborAlive = true;
        let fredbearAggro = false;
        let fredbearSpeed = 0;
        let gameOver = false;
        let isStunned = false;

        const keys = {w:false, a:false, s:false, d:false};
        
        document.addEventListener('keydown', e => {
            const k = e.key.toLowerCase();
            keys[k] = true;
            
            // Size Controls (O / P)
            if(fredbearModel) {
                if(k === 'p') {
                    scaleVal += 1;
                    fredbearModel.scale.set(scaleVal, scaleVal, scaleVal);
                    document.getElementById('size-display').innerText = scaleVal.toFixed(1);
                }
                if(k === 'o') {
                    scaleVal = Math.max(0.1, scaleVal - 1);
                    fredbearModel.scale.set(scaleVal, scaleVal, scaleVal);
                    document.getElementById('size-display').innerText = scaleVal.toFixed(1);
                }
            }
        });
        
        document.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);
        
        document.addEventListener('mousedown', () => {
            if(!gameOver) {
                document.body.requestPointerLock();
                shoot();
            }
        });
        document.addEventListener('mousemove', e => {
            if(document.pointerLockElement && !gameOver) camera.rotation.y -= e.movementX * 0.002;
        });

        function shoot() {
            gun.material.color.setHex(0xffff00);
            setTimeout(() => gun.material.color.setHex(0x555555), 100);

            const ray = new THREE.Raycaster();
            ray.setFromCamera(new THREE.Vector2(0,0), camera);

            // 1. Neighbor Logic
            if(neighborAlive) {
                const hits = ray.intersectObject(nMesh);
                if(hits.length > 0 && hits[0].distance < 100) {
                    neighborAlive = false;
                    neighbor.rotation.x = -Math.PI/2; 
                    
                    // NEIGHBOR DEAD -> ACTIVATE FREDBEAR RUN
                    fredbearAggro = true;
                    fredbearSpeed = 0.6; 
                    playAnimation(ANIM_RUN); // Switch to Run [16]
                    
                    audioRun.play().catch(e=>console.log("Audio waiting"));
                    document.getElementById('status').innerHTML = "NEIGHBOR DOWN! <span style='color:red'>RUN!</span>";
                }
            }
            
            // 2. Fredbear Logic (Stun)
            if(fredbearModel && fredbearAggro && !isStunned) {
                 const dist = camera.position.distanceTo(fredbearModel.position);
                 const camDir = new THREE.Vector3(); camera.getWorldDirection(camDir);
                 const toFred = fredbearModel.position.clone().sub(camera.position).normalize();
                 
                 // If looking at him and close enough
                 if(camDir.dot(toFred) > 0.8 && dist < 100) {
                     isStunned = true;
                     fredbearSpeed = 0; 
                     
                     // PLAY BEARTRAP ANIMATION [1]
                     playAnimation(ANIM_STUN);
                     
                     // Wait 2 seconds, then resume RUN [16]
                     setTimeout(() => { 
                         if(!gameOver) {
                            isStunned = false;
                            fredbearSpeed = 0.6; 
                            playAnimation(ANIM_RUN);
                         }
                     }, 2000);
                 }
            }
        }

        const clock = new THREE.Clock();
        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();

            if(!gameOver) {
                const dir = new THREE.Vector3(); camera.getWorldDirection(dir); dir.y=0; dir.normalize();
                const right = new THREE.Vector3(-dir.z, 0, dir.x);
                if(keys.w) camera.position.addScaledVector(dir, 0.6);
                if(keys.s) camera.position.addScaledVector(dir, -0.6);
                if(keys.a) camera.position.addScaledVector(right, -0.6);
                if(keys.d) camera.position.addScaledVector(right, 0.6);
            }

            if(mixer) mixer.update(delta);

            if(fredbearModel && !gameOver) {
                // Always face player
                fredbearModel.lookAt(camera.position.x, 0, camera.position.z);
                
                if(fredbearAggro) {
                    // Move forward if not stunned
                    fredbearModel.translateZ(fredbearSpeed * (scaleVal/10)); 
                    
                    // Collision
                    if(camera.position.distanceTo(fredbearModel.position) < (scaleVal * 1.5)) {
                        gameOver = true;
                        document.exitPointerLock();
                        document.getElementById('jumpscare-container').style.display = 'flex';
                        audioRun.pause();
                        scareVid.play();
                    }
                }
            }
            renderer.render(scene, camera);
        }
        animate();
        window.onresize=()=>{camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix();renderer.setSize(window.innerWidth,window.innerHeight)};
    </script>
</body>
</html>
