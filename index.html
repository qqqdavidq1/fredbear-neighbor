<!DOCTYPE html>
<html>
<head>
    <title>Hello Neighbor: FREDBEAR MOD</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Courier New', monospace; user-select: none; }
        
        #hud {
            position: absolute; top: 20px; left: 20px;
            color: #ffaa00; font-size: 20px; font-weight: bold;
            text-shadow: 2px 2px 0 #000;
            z-index: 10;
        }
        
        #crosshair {
            position: absolute; top: 50%; left: 50%; width: 6px; height: 6px;
            background: white; border: 2px solid black; border-radius: 50%; 
            transform: translate(-50%, -50%); pointer-events: none;
            z-index: 10;
        }

        /* JUMPSCARE VIDEO CONTAINER */
        #jumpscare-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: black; display: none; z-index: 999;
            align-items: center; justify-content: center;
        }

        video {
            width: 100%; height: 100%; object-fit: cover;
        }

        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; font-size: 24px; font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="loading">LOADING FREDBEAR & AUDIO...</div>
    
    <div id="crosshair"></div>
    
    <div id="jumpscare-container">
        <video id="scare-vid" src="jumpscare.mp4"></video>
    </div>

    <div id="hud">
        NEIGHBOR: ACTIVE<br>
        FREDBEAR: WAITING...
    </div>

    <script type="module">
        import * as THREE from 'https://unpkg.com/three@0.126.0/build/three.module.js';
        import { GLTFLoader } from 'https://unpkg.com/three@0.126.0/examples/jsm/loaders/GLTFLoader.js';

        // --- SETUP ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x556677);
        scene.fog = new THREE.Fog(0x556677, 10, 200);

        const camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 500);
        camera.position.set(0, 10, 100); 
        camera.rotation.y = Math.PI;

        const renderer = new THREE.WebGLRenderer({antialias:true});
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.outputEncoding = THREE.sRGBEncoding; 
        document.body.appendChild(renderer.domElement);

        const light = new THREE.HemisphereLight(0xffffff, 0x444444, 1.0);
        scene.add(light);
        const dirLight = new THREE.DirectionalLight(0xffffff, 1.5);
        dirLight.position.set(50, 100, 50);
        scene.add(dirLight);

        // --- 3D AUDIO SYSTEM ---
        const listener = new THREE.AudioListener();
        camera.add(listener); // Ears are on the camera

        // Create the Positional Audio for Fredbear
        const runSound = new THREE.PositionalAudio(listener);
        const audioLoader = new THREE.AudioLoader();
        
        audioLoader.load('run.mp3', function(buffer) {
            runSound.setBuffer(buffer);
            runSound.setRefDistance(10); // Distance where volume starts dropping
            runSound.setRolloffFactor(1.5); // How fast volume drops
            runSound.setLoop(true);
            runSound.setVolume(2.0); // Make it loud
        });

        // Jumpscare Video Logic
        const scareVid = document.getElementById('scare-vid');
        const scareContainer = document.getElementById('jumpscare-container');
        scareVid.onended = function() { location.reload(); };

        // --- WORLD ---
        const ground = new THREE.Mesh(new THREE.PlaneGeometry(1000,1000), new THREE.MeshStandardMaterial({color: 0x223322}));
        ground.rotation.x = -Math.PI/2;
        scene.add(ground);

        // --- THE NEIGHBOR (Red Box Placeholder) ---
        const neighbor = new THREE.Group();
        const nGeo = new THREE.BoxGeometry(4, 12, 4);
        const nMat = new THREE.MeshStandardMaterial({color: 0xff0000});
        const nMesh = new THREE.Mesh(nGeo, nMat);
        nMesh.position.y = 6;
        neighbor.add(nMesh);
        scene.add(neighbor);
        neighbor.position.set(-20, 0, -50);

        // --- FREDBEAR (Your GLTF Model) ---
        let fredbearModel = null;
        let mixer = null; 
        const loader = new GLTFLoader();
        
        loader.load('scene.gltf', function (gltf) {
            fredbearModel = gltf.scene;
            
            // Scale him: Try 0.1 first. 
            // If he is invisible, change to 100. If he is huge, change to 0.01.
            fredbearModel.scale.set(0.1, 0.1, 0.1); 
            
            fredbearModel.position.set(20, 0, -50); 
            
            // Attach 3D Sound to the model
            fredbearModel.add(runSound);
            
            if(gltf.animations.length > 0) {
                mixer = new THREE.AnimationMixer(fredbearModel);
                const action = mixer.clipAction(gltf.animations[0]); 
                action.play();
            }

            scene.add(fredbearModel);
            document.getElementById('loading').style.display = 'none';
        }, undefined, function (error) {
            console.error(error);
            document.getElementById('loading').innerText = "ERROR loading scene.gltf";
        });

        // --- SHOTGUN ---
        const gun = new THREE.Mesh(new THREE.BoxGeometry(1, 1, 6), new THREE.MeshStandardMaterial({color: 0x555555}));
        gun.position.set(2, -2, -4);
        camera.add(gun);

        // --- GAME LOGIC ---
        let neighborAlive = true;
        let fredbearAggro = false;
        let fredbearSpeed = 0;
        const NORMAL_SPEED = 0.65; 
        const SLOWED_SPEED = 0.1; 
        let slowTimer = 0;
        let gameOver = false;

        // Controls
        const keys = {w:false, a:false, s:false, d:false};
        document.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
        document.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);
        
        // Pointer Lock & Audio Unlock
        document.addEventListener('mousedown', () => {
            if(!gameOver) {
                document.body.requestPointerLock();
                // Browsers block audio until user clicks
                if(listener.context.state === 'suspended') {
                    listener.context.resume();
                }
                shoot();
            }
        });
        
        document.addEventListener('mousemove', e => {
            if(document.pointerLockElement && !gameOver) {
                camera.rotation.y -= e.movementX * 0.002;
            }
        });

        function shoot() {
            gun.material.color.setHex(0xffff00);
            setTimeout(() => gun.material.color.setHex(0x555555), 100);

            const ray = new THREE.Raycaster();
            ray.setFromCamera(new THREE.Vector2(0,0), camera);
            
            // Hit Neighbor
            if(neighborAlive) {
                const hits = ray.intersectObject(nMesh);
                if(hits.length > 0 && hits[0].distance < 100) {
                    neighborAlive = false;
                    neighbor.rotation.x = -Math.PI/2; 
                    
                    // TRIGGER FREDBEAR
                    fredbearAggro = true;
                    fredbearSpeed = NORMAL_SPEED;
                    
                    // Play 3D Sound
                    if(!runSound.isPlaying) runSound.play();
                    
                    document.getElementById('hud').innerHTML = "NEIGHBOR: DOWN<br><span style='color:red'>FREDBEAR: ENRAGED!</span>";
                }
            }

            // Hit Fredbear
            if(fredbearModel) {
                const dist = camera.position.distanceTo(fredbearModel.position);
                const dir = new THREE.Vector3(); 
                fredbearModel.getWorldPosition(dir);
                dir.sub(camera.position).normalize();
                
                const camDir = new THREE.Vector3();
                camera.getWorldDirection(camDir);
                
                if(camDir.dot(dir) > 0.9 && dist < 100) {
                    fredbearSpeed = SLOWED_SPEED;
                    slowTimer = 60; 
                }
            }
        }

        const clock = new THREE.Clock();

        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();

            if(!gameOver) {
                const dir = new THREE.Vector3(); camera.getWorldDirection(dir); dir.y=0; dir.normalize();
                const right = new THREE.Vector3(-dir.z, 0, dir.x);
                if(keys.w) camera.position.addScaledVector(dir, 0.6);
                if(keys.s) camera.position.addScaledVector(dir, -0.6);
                if(keys.a) camera.position.addScaledVector(right, -0.6);
                if(keys.d) camera.position.addScaledVector(right, 0.6);
            }

            if(mixer) mixer.update(delta);

            // AI LOGIC
            if(fredbearModel && !gameOver) {
                if(neighborAlive) {
                    fredbearModel.lookAt(camera.position.x, 0, camera.position.z);
                } 
                else if (fredbearAggro) {
                    if(slowTimer > 0) slowTimer--;
                    else fredbearSpeed = NORMAL_SPEED;

                    fredbearModel.lookAt(camera.position.x, 0, camera.position.z);
                    fredbearModel.translateZ(fredbearSpeed); 

                    // JUMPSCARE TRIGGER
                    if(camera.position.distanceTo(fredbearModel.position) < 4) {
                        triggerJumpscare();
                    }
                }
            }

            renderer.render(scene, camera);
        }

        function triggerJumpscare() {
            gameOver = true;
            document.exitPointerLock();
            document.getElementById('hud').style.display = 'none';
            document.getElementById('crosshair').style.display = 'none';
            
            if(runSound.isPlaying) runSound.stop(); // Stop running sound

            scareContainer.style.display = 'flex';
            scareVid.play();
        }

        animate();

        window.onresize = () => {
            camera.aspect = window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
    </script>
</body>
</html>
